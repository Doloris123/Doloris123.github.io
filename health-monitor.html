<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健康监测 - 智慧健康平台</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .monitor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .audio-recorder {
            text-align: center;
        }

        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .record-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 25px rgba(255,107,107,0.4);
        }

        .record-btn.recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .audio-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .health-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .indicator {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .indicator-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .indicator-label {
            color: #666;
            font-size: 0.9rem;
        }

        .analysis-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .analysis-result {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 15px 0;
        }

        .result-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
        }

        .status-normal { background: #2ecc71; }
        .status-warning { background: #f39c12; }
        .status-alert { background: #e74c3c; }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .monitor-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-stethoscope"></i> 健康监测</h1>
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> 返回主页
            </button>
        </div>

        <div class="monitor-grid">
            <div class="card audio-recorder">
                <div class="card-title">
                    <i class="fas fa-microphone"></i>
                    音频健康检测
                </div>
                <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                    <i class="fas fa-microphone"></i>
                </button>
                <div class="audio-status" id="audioStatus">
                    点击按钮开始录音，系统将分析您的健康状况
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="analyzeAudio()">
                        <i class="fas fa-brain"></i>
                        开始分析
                    </button>
                    <button class="btn btn-secondary" onclick="clearRecording()">
                        <i class="fas fa-trash"></i>
                        清除录音
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <i class="fas fa-heartbeat"></i>
                    实时健康指标
                </div>
                <div class="health-indicators">
                    <div class="indicator">
                        <div class="indicator-value" id="heartRate">72</div>
                        <div class="indicator-label">心率 (bpm)</div>
                    </div>
                    <div class="indicator">
                        <div class="indicator-value" id="bloodPressure">120/80</div>
                        <div class="indicator-label">血压 (mmHg)</div>
                    </div>
                    <div class="indicator">
                        <div class="indicator-value" id="temperature">36.8°C</div>
                        <div class="indicator-label">体温</div>
                    </div>
                    <div class="indicator">
                        <div class="indicator-value" id="oxygen">98%</div>
                        <div class="indicator-label">血氧饱和度</div>
                    </div>
                    <div class="indicator">
                        <div class="indicator-value" id="respiratory">16</div>
                        <div class="indicator-label">呼吸频率</div>
                    </div>
                    <div class="indicator">
                        <div class="indicator-value" id="stress">低</div>
                        <div class="indicator-label">压力水平</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="analysis-section">
            <div class="card-title">
                <i class="fas fa-chart-line"></i>
                LSTM模型分析结果
            </div>
            <div class="analysis-result" id="analysisResult" style="display: none;">
                <div class="result-status">
                    <span class="status-badge status-normal" id="healthStatus">正常</span>
                    <span id="healthDescription">您的健康状况良好，各项指标正常</span>
                </div>
                <div>
                    <strong>置信度: </strong><span id="confidence">95%</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="healthChart"></canvas>
            </div>
        </div>

        <div class="analysis-section">
            <div class="card-title">
                <i class="fas fa-lightbulb"></i>
                健康建议
            </div>
            <div id="healthAdvice">
                <p>• 建议每天进行30分钟的有氧运动</p>
                <p>• 保持充足的睡眠，每晚7-8小时</p>
                <p>• 注意饮食均衡，多摄入蔬菜水果</p>
                <p>• 定期进行健康检查</p>
            </div>
        </div>
    </div>

    <script>
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let healthChart = null;

        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('healthChart').getContext('2d');
            healthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                    datasets: [{
                        label: '心率',
                        data: [72, 68, 75, 78, 72, 70],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4
                    }, {
                        label: '血压(收缩压)',
                        data: [120, 118, 125, 128, 122, 120],
                        borderColor: '#4ecdc4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // 切换录音状态
        function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            const audioStatus = document.getElementById('audioStatus');
            const progressFill = document.getElementById('progressFill');

            if (!isRecording) {
                startRecording();
                recordBtn.classList.add('recording');
                recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                audioStatus.textContent = '正在录音...';
                isRecording = true;
            } else {
                stopRecording();
                recordBtn.classList.remove('recording');
                recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                audioStatus.textContent = '录音完成，点击"开始分析"进行健康检测';
                isRecording = false;
            }
        }

        // 开始录音
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    // 这里可以保存音频文件或发送到后端进行分析
                    console.log('录音完成:', audioBlob);
                };

                mediaRecorder.start();
                
                // 模拟录音进度
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 2;
                    document.getElementById('progressFill').style.width = progress + '%';
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                    }
                }, 100);

            } catch (error) {
                console.error('录音失败:', error);
                alert('无法访问麦克风，请检查权限设置');
            }
        }

        // 停止录音
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        // 分析音频
        async function analyzeAudio() {
            const analysisResult = document.getElementById('analysisResult');
            const healthStatus = document.getElementById('healthStatus');
            const healthDescription = document.getElementById('healthDescription');
            const confidence = document.getElementById('confidence');

            // 显示加载状态
            analysisResult.style.display = 'flex';
            healthStatus.textContent = '分析中...';
            healthStatus.className = 'status-badge status-warning';
            healthDescription.textContent = '正在使用LSTM模型分析您的健康状况...';

            try {
                // 创建FormData对象
                const formData = new FormData();
                if (audioChunks.length > 0) {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    formData.append('audio', audioBlob, 'recording.wav');
                } else {
                    // 如果没有录音，发送模拟数据
                    const emptyBlob = new Blob([''], { type: 'audio/wav' });
                    formData.append('audio', emptyBlob, 'recording.wav');
                }

                // 发送到后端API
                const response = await fetch('http://localhost:5000/api/health/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    const prediction = data.prediction;
                    healthStatus.textContent = prediction.status;
                    
                    if (prediction.status === '正常') {
                        healthStatus.className = 'status-badge status-normal';
                    } else if (prediction.status === '注意') {
                        healthStatus.className = 'status-badge status-warning';
                    } else {
                        healthStatus.className = 'status-badge status-alert';
                    }
                    
                    healthDescription.textContent = prediction.description;
                    confidence.textContent = prediction.confidence + '%';

                    // 更新健康建议
                    updateHealthAdvice(data.advice);
                } else {
                    throw new Error(data.error || '分析失败');
                }

                // 更新健康指标
                await updateHealthIndicators();
                
            } catch (error) {
                console.error('分析失败:', error);
                healthStatus.textContent = '分析失败';
                healthStatus.className = 'status-badge status-alert';
                healthDescription.textContent = '请重试或检查网络连接';
                confidence.textContent = '0%';
            }
        }

        // 更新健康指标
        async function updateHealthIndicators() {
            try {
                const response = await fetch('http://localhost:5000/api/health/indicators');
                const data = await response.json();

                if (data.success) {
                    const indicators = data.indicators;
                    
                    document.getElementById('heartRate').textContent = indicators.heart_rate;
                    document.getElementById('bloodPressure').textContent = 
                        `${indicators.blood_pressure_systolic}/${indicators.blood_pressure_diastolic}`;
                    document.getElementById('temperature').textContent = indicators.temperature + '°C';
                    document.getElementById('oxygen').textContent = indicators.oxygen_saturation + '%';
                    document.getElementById('respiratory').textContent = indicators.respiratory_rate;
                    document.getElementById('stress').textContent = indicators.stress_level;
                }
            } catch (error) {
                console.error('获取健康指标失败:', error);
                // 使用模拟数据作为备用
                const indicators = {
                    heartRate: Math.floor(Math.random() * 30) + 60,
                    bloodPressure: `${Math.floor(Math.random() * 40) + 110}/${Math.floor(Math.random() * 20) + 70}`,
                    temperature: (36.5 + Math.random() * 0.8).toFixed(1) + '°C',
                    oxygen: Math.floor(Math.random() * 5) + 95 + '%',
                    respiratory: Math.floor(Math.random() * 8) + 12,
                    stress: ['低', '中', '高'][Math.floor(Math.random() * 3)]
                };

                Object.keys(indicators).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.textContent = indicators[key];
                    }
                });
            }
        }

        // 更新健康建议
        function updateHealthAdvice(advice) {
            const adviceContainer = document.getElementById('healthAdvice');
            if (advice && advice.length > 0) {
                adviceContainer.innerHTML = advice.map(item => `<p>• ${item}</p>`).join('');
            }
        }

        // 清除录音
        function clearRecording() {
            audioChunks = [];
            document.getElementById('audioStatus').textContent = '点击按钮开始录音，系统将分析您的健康状况';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('analysisResult').style.display = 'none';
        }

        // 返回主页
        function goBack() {
            window.location.href = 'index.html';
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('健康监测页面已加载');
            initChart();
            
            // 模拟实时数据更新
            setInterval(function() {
                if (!isRecording) {
                    updateHealthIndicators();
                }
            }, 10000);
        });
    </script>
</body>
</html>
