<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>移动健康数据采集器</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-connected { background-color: #2ecc71; }
        .status-disconnected { background-color: #e74c3c; }
        .status-connecting { background-color: #f39c12; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .data-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .data-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .data-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .data-label {
            color: #666;
            font-size: 0.9rem;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-time {
            color: #888;
        }

        .log-info { color: #00ff00; }
        .log-warning { color: #ffff00; }
        .log-error { color: #ff0000; }

        .sensor-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .sensor-name {
            font-weight: bold;
        }

        .sensor-value {
            color: #667eea;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        @media (max-width: 480px) {
            .data-grid {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-mobile-alt"></i> 移动健康数据采集器</h1>
            <p>实时监测并传输健康数据到平台</p>
        </div>

        <div class="status-card">
            <div class="card-title">
                <span class="status-indicator status-disconnected" id="connectionStatus"></span>
                连接状态
            </div>
            <div id="connectionInfo">未连接到服务器</div>
            <div class="progress-bar">
                <div class="progress-fill" id="connectionProgress" style="width: 0%"></div>
            </div>
        </div>

        <div class="data-card">
            <div class="card-title">
                <i class="fas fa-heartbeat"></i>
                实时健康数据
            </div>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-value" id="heartRate">--</div>
                    <div class="data-label">心率 (bpm)</div>
                </div>
                <div class="data-item">
                    <div class="data-value" id="bloodPressure">--/--</div>
                    <div class="data-label">血压 (mmHg)</div>
                </div>
                <div class="data-item">
                    <div class="data-value" id="temperature">--°C</div>
                    <div class="data-label">体温</div>
                </div>
                <div class="data-item">
                    <div class="data-value" id="oxygen">--%</div>
                    <div class="data-label">血氧饱和度</div>
                </div>
            </div>
            
            <div class="sensor-status">
                <span class="sensor-name">加速度传感器</span>
                <span class="sensor-value" id="accelerometer">未激活</span>
            </div>
            <div class="sensor-status">
                <span class="sensor-name">陀螺仪</span>
                <span class="sensor-value" id="gyroscope">未激活</span>
            </div>
            <div class="sensor-status">
                <span class="sensor-name">麦克风</span>
                <span class="sensor-value" id="microphone">未激活</span>
            </div>
        </div>

        <div class="data-card">
            <div class="card-title">
                <i class="fas fa-cogs"></i>
                控制面板
            </div>
            <div class="control-buttons">
                <button class="btn btn-primary" id="startBtn" onclick="startDataCollection()">
                    <i class="fas fa-play"></i>
                    开始采集
                </button>
                <button class="btn btn-secondary" id="stopBtn" onclick="stopDataCollection()" disabled>
                    <i class="fas fa-stop"></i>
                    停止采集
                </button>
                <button class="btn btn-secondary" onclick="connectToServer()">
                    <i class="fas fa-wifi"></i>
                    连接服务器
                </button>
                <button class="btn btn-danger" onclick="emergencyAlert()">
                    <i class="fas fa-exclamation-triangle"></i>
                    紧急求助
                </button>
            </div>
        </div>

        <div class="data-card">
            <div class="card-title">
                <i class="fas fa-terminal"></i>
                系统日志
            </div>
            <div class="log-container" id="logContainer">
                <div class="log-entry">
                    <span class="log-time">[系统启动]</span>
                    <span class="log-info">移动健康数据采集器已初始化</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let isCollecting = false;
        let isConnected = false;
        let dataInterval = null;
        let connectionInterval = null;
        let audioContext = null;
        let mediaStream = null;
        let serverUrl = 'http://localhost:5000';

        // 传感器数据
        let sensorData = {
            heartRate: 0,
            bloodPressure: { systolic: 0, diastolic: 0 },
            temperature: 0,
            oxygen: 0,
            accelerometer: { x: 0, y: 0, z: 0 },
            gyroscope: { x: 0, y: 0, z: 0 },
            audioLevel: 0,
            timestamp: new Date()
        };

        // 日志函数
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">[${timestamp}]</span>
                <span class="log-${type}">${message}</span>
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 连接服务器
        async function connectToServer() {
            const statusIndicator = document.getElementById('connectionStatus');
            const connectionInfo = document.getElementById('connectionInfo');
            const progressFill = document.getElementById('connectionProgress');

            statusIndicator.className = 'status-indicator status-connecting';
            connectionInfo.textContent = '正在连接服务器...';
            progressFill.style.width = '50%';

            try {
                // 测试连接
                const response = await fetch(`${serverUrl}/api/health/check`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type: 'connection_test' })
                });

                if (response.ok) {
                    isConnected = true;
                    statusIndicator.className = 'status-indicator status-connected';
                    connectionInfo.textContent = '已连接到服务器';
                    progressFill.style.width = '100%';
                    addLog('成功连接到服务器', 'info');

                    // 开始心跳检测
                    startHeartbeat();
                } else {
                    throw new Error('服务器响应异常');
                }
            } catch (error) {
                isConnected = false;
                statusIndicator.className = 'status-indicator status-disconnected';
                connectionInfo.textContent = '连接失败: ' + error.message;
                progressFill.style.width = '0%';
                addLog('连接服务器失败: ' + error.message, 'error');
            }
        }

        // 心跳检测
        function startHeartbeat() {
            connectionInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${serverUrl}/api/health/check`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ type: 'heartbeat' })
                    });

                    if (!response.ok) {
                        throw new Error('心跳检测失败');
                    }
                } catch (error) {
                    addLog('心跳检测失败，尝试重连...', 'warning');
                    isConnected = false;
                    document.getElementById('connectionStatus').className = 'status-indicator status-disconnected';
                    document.getElementById('connectionInfo').textContent = '连接断开，正在重连...';
                }
            }, 30000); // 每30秒检测一次
        }

        // 开始数据采集
        async function startDataCollection() {
            if (!isConnected) {
                addLog('请先连接服务器', 'warning');
                return;
            }

            isCollecting = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            addLog('开始数据采集', 'info');

            // 请求传感器权限
            await requestSensorPermissions();

            // 开始定期采集数据
            dataInterval = setInterval(collectSensorData, 2000); // 每2秒采集一次

            // 立即采集一次数据
            collectSensorData();
        }

        // 停止数据采集
        function stopDataCollection() {
            isCollecting = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;

            if (dataInterval) {
                clearInterval(dataInterval);
                dataInterval = null;
            }

            // 停止音频流
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            addLog('停止数据采集', 'info');
        }

        // 请求传感器权限
        async function requestSensorPermissions() {
            try {
                // 请求麦克风权限
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                document.getElementById('microphone').textContent = '已激活';
                addLog('麦克风权限获取成功', 'info');

                // 初始化音频分析
                initAudioAnalysis();

            } catch (error) {
                addLog('传感器权限获取失败: ' + error.message, 'error');
            }
        }

        // 初始化音频分析
        function initAudioAnalysis() {
            if (!mediaStream) return;

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(mediaStream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;

                source.connect(analyser);
                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                function updateAudioLevel() {
                    if (!isCollecting) return;
                    
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    sensorData.audioLevel = average;
                    
                    requestAnimationFrame(updateAudioLevel);
                }

                updateAudioLevel();
            } catch (error) {
                addLog('音频分析初始化失败: ' + error.message, 'error');
            }
        }

        // 采集传感器数据
        function collectSensorData() {
            if (!isCollecting) return;

            // 模拟传感器数据（实际应用中应该从真实传感器获取）
            sensorData = {
                heartRate: Math.floor(Math.random() * 30) + 60,
                bloodPressure: {
                    systolic: Math.floor(Math.random() * 40) + 110,
                    diastolic: Math.floor(Math.random() * 20) + 70
                },
                temperature: (36.5 + Math.random() * 0.8).toFixed(1),
                oxygen: Math.floor(Math.random() * 5) + 95,
                accelerometer: {
                    x: (Math.random() - 0.5) * 2,
                    y: (Math.random() - 0.5) * 2,
                    z: (Math.random() - 0.5) * 2
                },
                gyroscope: {
                    x: (Math.random() - 0.5) * 10,
                    y: (Math.random() - 0.5) * 10,
                    z: (Math.random() - 0.5) * 10
                },
                audioLevel: sensorData.audioLevel || 0,
                timestamp: new Date()
            };

            // 更新UI显示
            updateDataDisplay();

            // 发送数据到服务器
            sendDataToServer();
        }

        // 更新数据显示
        function updateDataDisplay() {
            document.getElementById('heartRate').textContent = sensorData.heartRate;
            document.getElementById('bloodPressure').textContent = 
                `${sensorData.bloodPressure.systolic}/${sensorData.bloodPressure.diastolic}`;
            document.getElementById('temperature').textContent = sensorData.temperature + '°C';
            document.getElementById('oxygen').textContent = sensorData.oxygen + '%';
            
            document.getElementById('accelerometer').textContent = 
                `X:${sensorData.accelerometer.x.toFixed(2)} Y:${sensorData.accelerometer.y.toFixed(2)} Z:${sensorData.accelerometer.z.toFixed(2)}`;
            document.getElementById('gyroscope').textContent = 
                `X:${sensorData.gyroscope.x.toFixed(2)} Y:${sensorData.gyroscope.y.toFixed(2)} Z:${sensorData.gyroscope.z.toFixed(2)}`;
        }

        // 发送数据到服务器
        async function sendDataToServer() {
            if (!isConnected) return;

            try {
                const response = await fetch(`${serverUrl}/api/health/real-time-data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_id: 'mobile_device_001',
                        user_id: 'user_001',
                        data: sensorData,
                        timestamp: sensorData.timestamp.toISOString()
                    })
                });

                if (response.ok) {
                    addLog('数据发送成功', 'info');
                } else {
                    throw new Error('服务器响应异常');
                }
            } catch (error) {
                addLog('数据发送失败: ' + error.message, 'error');
            }
        }

        // 紧急求助
        async function emergencyAlert() {
            try {
                const response = await fetch(`${serverUrl}/api/emergency/call`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location: '移动设备位置',
                        device_id: 'mobile_device_001',
                        user_id: 'user_001',
                        sensor_data: sensorData
                    })
                });

                if (response.ok) {
                    addLog('紧急求助信号已发送', 'warning');
                    alert('紧急求助信号已发送，救援人员将尽快到达！');
                } else {
                    throw new Error('紧急求助发送失败');
                }
            } catch (error) {
                addLog('紧急求助失败: ' + error.message, 'error');
                alert('紧急求助发送失败，请手动拨打紧急电话！');
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            addLog('移动健康数据采集器启动完成', 'info');
            
            // 自动尝试连接服务器
            setTimeout(connectToServer, 1000);
        });

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', function() {
            if (dataInterval) {
                clearInterval(dataInterval);
            }
            if (connectionInterval) {
                clearInterval(connectionInterval);
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
